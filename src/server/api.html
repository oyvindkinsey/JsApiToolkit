<!doctype html>
<html>
    <head>
        <title>API</title>
        <script type="text/javascript">
            var dependencies = /* These are the dependencies that we need to have present */ {
                "JSON": "../../lib/json2.js",
                "easyXDM": "../../lib/easyXDM.min.js"
            };
            for (var dependency in dependencies) {
                if (dependencies.hasOwnProperty(dependency) && !(dependency in this)) {
                    document.write(decodeURIComponent('%3Cscript type="text/javascript" src="' + dependencies[dependency] + '"%3E%3C/script%3E'));
                }
            }
            // #endif
        </script>
        <script type="text/javascript">
            var state = {
                signed_in: false,
                appKey: easyXDM.query.appKey
            };
            var popup;
            var serverRoot = location.href.substring(0, location.href.lastIndexOf("/") + 1);
            
            var handlers = {};
            var rpcId = 0;
            var rpc = new easyXDM.Rpc({
                local: "name.html"
            }, {
                local: {
                    api: function(methodName, args, fn){
                        if (methodName in handlers) {
                            // this is handled locally
                            return handlers[methodName](args, fn);
                        }
                        else {
                            // this must be handled on the server
                            easyXDM.ajax({
                                method: "POST",
                                headers: {
                                    "auth-appKey": state.appKey
                                },
                                data: {
                                    jsonrpc: "2.00",
                                    id: ++rpcId,
                                    method: methodName,
                                    params: JSON.stringify(args)
                                },
                                url: "json-rpc.aspx" /* "json-rpc.php" */,
                                type: "json",
                                success: function(response){
                                    fn({
                                        status: "ok",
                                        data: response.result
                                    });
                                },
                                error: function(response){
                                    fn({
                                        status: "error",
                                        data: response.message
                                    });
                                }
                            });
                        }
                    }
                },
                remote: {
                    publish: {}
                }
            });
            rpc.publish("auth.change", state.signed_in);
            function signIn(username, password, fn){
                easyXDM.ajax({
                    method: "POST",
                    headers: {
                        "auth-appKey": state.appKey
                    },
                    data: {
                        jsonrpc: "2.00",
                        id: ++rpcId,
                        method: "auth.authenticate",
                        params: JSON.stringify({
                            username: username,
                            password: password
                        })
                    },
                    url: "json-rpc.aspx" /* "json-rpc.php" */,
                    type: "json",
                    success: function(response){
                        fn(true);
                        state.signed_in = true;
                        rpc.publish("auth.change", true);
                    },
                    error: function(response){
                        fn(false);
                    }
                });
            }
        </script>
    </head>
    <body>
    </body>
</html>
