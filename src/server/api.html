<!doctype html>
<html>
    <head>
        <title>API</title>
        <script type="text/javascript">
            var PROTO = location.protocol;
            if (!("easyXDM" in this)) {
                document.write(decodeURIComponent('%3Cscript type="text/javascript" src="' + PROTO + '//easyxdm.net/current/easyXDM.min.js"%3E%3C/script%3E'));
            }
            if (!("JSON" in this)) {
                document.write(decodeURIComponent('%3Cscript type="text/javascript" src="' + PROTO + '//easyxdm.net/current/json2.js"%3E%3C/script%3E'));
            }
        </script>
        <script type="text/javascript">
            var state = {
                signed_in: false
            };
            var popup;
            var serverRoot = location.href.substring(0, location.href.lastIndexOf("/") + 1);
            
            var handlers = {
                "popup": function(args, fn){
                    popup = window.open(serverRoot + args.url, args.target);
                }
            };
            var rpcId = 0;
            var rpc = new easyXDM.Rpc({
                local: "name.html"
            }, {
                local: {
                    api: function(methodName, args, fn){
                        if (methodName in handlers) {
                            // this is handled locally
                            return handlers[methodName](args, fn);
                        }
                        else {
                            // this must be handled on the server
                            easyXDM.ajax({
                                method: "POST",
                                data: {
                                    jsonrpc: "2.00",
                                    id: ++rpcId,
                                    method: methodName,
                                    params: args
                                },
                                url: "json-rpc.aspx" /* "json-rpc.php" */,
                                type: "json",
                                success: function(response){
                                    fn({
                                        status: "ok",
                                        data: response.result
                                    });
                                },
                                error: function(response){
                                    fn({
                                        status: "error",
                                        data: response.message
                                    });
                                }
                            });
                        }
                    }
                },
                remote: {
                    raiseEvent: {}
                }
            });
            rpc.raiseEvent("auth-status-change", state.signed_in);
            function signIn(username, password, fn){
                easyXDM.ajax({
                    method: "POST",
                    data: {
                        jsonrpc: "2.00",
                        id: ++rpcId,
                        method: "auth.authenticate",
                        params: {
                            username: username,
                            password: password
                        }
                    },
                    url: "json-rpc.aspx" /* "json-rpc.php" */,
                    type: "json",
                    success: function(response){
                        fn(true);
                        state.signed_in = true;
                        rpc.raiseEvent("auth-status-change", true);
                    },
                    error: function(response){
                        fn(false);
                    }
                });
            }
        </script>
    </head>
    <body>
    </body>
</html>
